@using ConstructionSiteLibrary.Managers
@using ConstructionSiteLibrary.Model
@using Microsoft.JSInterop

@inject ScreenManager ScreenManager
@inject IJSRuntime JS

@code {

    /// <summary>
    /// Evento che comunica il cambiamento della grandezza dello schermo
    /// </summary>
    [Parameter]
    public EventCallback<ScreenDimension?> OnScreenDimensionChanged { get; set; }

    [Parameter]
    public EventCallback<ScreenSize?> OnScreenSizeChanged { get; set; }

    [Parameter]
    public EventCallback<ScreenDimension?> OnMainDimensionChanged { get; set; }

    [Parameter]
    public EventCallback<ScreenSize?> OnMainSizeChanged { get; set; }

    /// <summary>
    /// Valore minimo della larghezza dello schermo per considerarlo small
    ///<remarks> tutte le dimensioni inferiori sono considerate XS</remarks>
    /// </summary>
    [Parameter]
    public int SizeS { get; set; } = 600;
    /// <summary>
    /// Valore minimo della larghezza dello schermo per considerarlo medium
    /// </summary>
    [Parameter]
    public int SizeM { get; set; } = 800;
    /// <summary>
    /// Valore minimo della larghezza dello schermo per considerarlo Large
    /// </summary>
    [Parameter]
    public int SizeL { get; set; } = 1100;
    /// <summary>
    /// Valore minimo della larghezza dello schermo per considerarlo XL
    /// </summary>
    [Parameter]
    public int SizeXL { get; set; } = 1400;

    /// <summary>
    /// La dimensione attuale dello schermo
    /// </summary>
    public ScreenDimension? ScreenDimension { get; set; }
    public ScreenSize? ScreenSize { get; set; }

    public ScreenDimension? MainDimension { get; set; }
    public ScreenSize? MainSize { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await ScreenSetup();
    }


    /// <summary>
    /// Inizializza il componente chiedendo al servizio ScreenManager le dimensioni attuali
    /// dello schermo e registrandosi all'evento Rezise del ScreenManager per le modifiche
    /// della view in tempo reale
    /// </summary>
    private async Task ScreenSetup()
    {
        await ScreenManager.Init(JS);
        ScreenSize = ScreenManager.GetScreenSize();
        ScreenDimension = CalculateScreenDimension(ScreenSize);
        MainSize = ScreenManager.GetMainSize();
        MainDimension = CalculateScreenDimension(MainSize);
        ScreenManager.ResizeScreen += ScreenDimensionChanged!;
        ScreenManager.ResizeMain += MainDimensionChanged!;

        CallScreenSizeEvent();
        CallMainSizeEvent();
        CallScreenDimensionEvent();
        CallMainDimensionEvent();
    }

    /// <summary>
    /// Metodo registrato all'evento del ScreenManager Resize
    /// </summary>
    /// <param name="sender">oggetto che invoca l'evento</param>
    /// <param name="size">le dimensioni dello schermo</param>
    private void ScreenDimensionChanged(object sender, ScreenSize size)
    {
        ScreenSize = size;
        CallScreenSizeEvent();
        var newDimension = CalculateScreenDimension(ScreenSize);
        if (newDimension != ScreenDimension)
        {
            ScreenDimension = newDimension;
            CallScreenDimensionEvent();
        }
    }

    private void MainDimensionChanged(object sender, ScreenSize size)
    {
        MainSize = size;
        CallMainSizeEvent();
        var newDimension = CalculateScreenDimension(MainSize);
        if (newDimension != ScreenDimension)
        {
            MainDimension = newDimension;
            CallMainDimensionEvent();
        }
    }

    /// <summary>
    /// Metodo per calcolare la grandezza dello schermo
    /// </summary>
    /// <param name="size"></param>
    private ScreenDimension? CalculateScreenDimension(ScreenSize? size)
    {
        ScreenDimension? dim = null;
        if(size is not null)
        {

            if(size.Width >= SizeXL)
            {
                dim = Model.ScreenDimension.XL;
            } 
            else if (size.Width >= SizeL)
            {
                dim = Model.ScreenDimension.L;
            }
            else if (size.Width >= SizeM)
            {
                dim = Model.ScreenDimension.M;
            }
            else if (size.Width >= SizeS)
            {
                dim = Model.ScreenDimension.S;
            }
            else
            {
                dim = Model.ScreenDimension.XS;
            }

        }
        return dim;
    }

    public ScreenSize GetScreenSize()
    {
        if (ScreenSize is null)
        {
            ScreenSize = ScreenManager.GetScreenSize() ?? new();
        }
        return ScreenSize;
    }

    public ScreenDimension GetScreenDimension()
    {
        if (ScreenSize is null)
        {
            ScreenSize = ScreenManager.GetScreenSize() ?? new();
        }
        var dimension = CalculateScreenDimension(ScreenSize);
        return dimension!.Value;
    }

    public ScreenSize GetMainSize()
    {
        if (MainSize is null)
        {
            MainSize = ScreenManager.GetMainSize() ?? new();
        }
        return MainSize;
    }

    public ScreenDimension GetMainDimension()
    {
        if (MainSize is null)
        {
            MainSize = ScreenManager.GetMainSize() ?? new();
        }
        var dimension = CalculateScreenDimension(MainSize);
        return dimension!.Value;
    }

    /// <summary>
    /// Metodo che fa scattare l'evento per comunicare a chi è in ascolto che la dimensione
    ///  dello schermo è cambiata
    /// </summary>
    private void CallScreenDimensionEvent() => OnScreenDimensionChanged.InvokeAsync(ScreenDimension);
    private void CallScreenSizeEvent() => OnScreenSizeChanged.InvokeAsync(ScreenSize);

    private void CallMainDimensionEvent() => OnMainDimensionChanged.InvokeAsync(MainDimension);
    private void CallMainSizeEvent() => OnMainSizeChanged.InvokeAsync(MainSize);
}
