@using ConstructionSiteLibrary.Model
@using ConstructionSiteLibrary.Model.DocumentCompilation
@using ConstructionSiteLibrary.Components.Generics;
@using Shared.Documents
@using Microsoft.JSInterop

@inject DialogService DialogService
@inject DocumentsRepository DocumentsRepository
@inject IJSRuntime JS

<ScreenComponent @ref="screenComponent" />

@if (onLoading)
{
    <Loading />
}
else
{
    <meta name="viewport" content="width=@viewSize.Width">
    <div class="">
            <ActivityTopBar OnButtonSaveClicked="SaveDocument" ListaAncore="@Anchors" />
        <ReportConstructorSiteDataSection Document="@document" Anchors="@Anchors"  OnAnchorAdd="@AnchorAdd"/>
        <CompaniesPresentSection Companies="@document.Companies" Anchors="@Anchors" OnAnchorAdd="@AnchorAdd" />
        <QuestionsSection Categories="document.Categories" Companies="document.Companies" OnStateChangeNotification="@UpdateDocument"
                          Anchors="@Anchors" OnAnchorAdd="@AnchorAdd" />
        <QuestionNotesSection Document="@document" Anchors="@Anchors" OnAnchorAdd="@AnchorAdd" />
        <AttachmentsSection Categories="@document.Categories" Anchors="@Anchors" OnAnchorAdd="@AnchorAdd" />
        <DocumentNoteSection Document="@document" Anchors="@Anchors" OnAnchorAdd="@AnchorAdd" />
        <CompaniesSignsSection Document="@document" Anchors="@Anchors" OnAnchorAdd="@AnchorAdd" />
       
    </div>
    <div class="d-flex justify-content-center mt-3">
        <RadzenButton Icon="save" Text="Salva" Click="SaveDocument" Style="width: 200px;height:40px;" IsBusy="@onSaving" />
        <div class="mx-2"></div>
        <RadzenButton Icon="article" Text="Anteprima" Click="StampaDocumento" Style="width:200px;height:40px;"/>
    </div>
    <div class="mt-3"></div>
}

@code {
    [Parameter]
    public int DocumentId { get; set; }
    private DocumentModel document = new();
    private bool onLoading = false;

    private bool onSaving = false;
    private ScreenSize viewSize = new();
    private ScreenSize nativeSize = new();

    public List<DocumentAnchor> Anchors { get; set; } = [];

    ScreenComponent screenComponent;

    protected override async Task OnInitializedAsync()
    {
        onLoading = true;
        await base.OnInitializedAsync();
        await LoadData();
        viewSize = screenComponent.GetScreenSize();
        nativeSize = viewSize.Clone();
        Anchors.Add(new DocumentAnchor(DocumentUtils.TypeConstructionSite, 0, DocumentUtils.ADatiVerbale.Text, DocumentUtils.ADatiVerbale.Anchor));
        Anchors.Add(new DocumentAnchor(DocumentUtils.TypeConstructionSite, 1, DocumentUtils.ADatiCantiere.Text, DocumentUtils.ADatiCantiere.Anchor));
        onLoading = false;
    }

    protected override void OnAfterRender(bool firstRender)
    {
        Anchors = Anchors.OrderBy(x => x.TypeIndex).ThenBy(x => x.Index).ToList();
        base.OnAfterRender(firstRender);
    }

    private async Task LoadData()
    {
        document = await DocumentsRepository.GetDocumentById(DocumentId);
    }

    private void UpdateDocument()
    {
        StateHasChanged();
    }

    private async Task StampaDocumento()
    {
        if(viewSize.Width < 1024)
        {
            viewSize.Width = 1024;
            StateHasChanged();
        }


        // creo uno style aggiuntivo da inviare al componente caricato con il popup come options
        var additionalStyle = $"height:{viewSize.Height};width:{viewSize.Width}px;-webkit-overflow-scrolling: touch;";
        var newOptions = new DialogOptions
            {
                Style = additionalStyle
            };
        //creo parametri da inviare al componente caricato con il popup
        var param = new Dictionary<string, object>
            {
                //tra i parametri che invio al dialog creo un EventCallback da passare al componente
                { "OnPrintComplete", EventCallback.Factory.Create(this, PrintComplete) },
                { "Document", document },
            };
        var success = await DialogService.OpenAsync<DocumentViewer>("", parameters: param, options: newOptions);
        PrintComplete();
    }

    private async Task SaveDocument()
    {
        onSaving = true;
        await DocumentsRepository.UpdateDocuments([document]);
        onSaving = false;
    }


    private void PrintComplete()
    {
        viewSize = nativeSize.Clone();
        StateHasChanged();
        DialogService.Close();
    }

    public void AnchorAdd()
    {
       // Anchors = Anchors.OrderBy(x => x.TypeIndex).ThenBy(x => x.Index).ToList();
    }

}
