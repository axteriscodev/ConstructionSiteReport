@using Shared.Documents
@using ConstructionSiteLibrary.Components.Utilities;
@using ConstructionSiteLibrary.Repositories;
@using ConstructionSiteLibrary.Utility;
@using Microsoft.AspNetCore.Components;
@using Radzen;
@using Radzen.Blazor;
@inject DialogService DialogService

@* NOTE AGGIUNTIVE *@
<div class="vstack px-4">
    <div class="my-4 ">
        <div class="row SectionTitleDiv">
            <RadzenText TextStyle="TextStyle.DisplayH6" TextAlign="TextAlign.Center" class="SectionTitle">
                <strong>
                    NOTE AGGIUNTIVE
                </strong>
            </RadzenText>
        </div>
        <div class="border my-4">
            @foreach (var nota in Document.Notes)
            {
                <RadzenColumn class="rz-text-align-center rz-border-info-light rz-p-8" Gap="1rem">
                    <RadzenTextArea Placeholder="Enter here..." class="w-100" Value="@nota.Text" />
                    <div class="row align-content-center">
                        <RadzenButton Text="Assegna azienda alla nota" Variant="Variant.Text"
                            Click="@(()=>OpenCompanyListDialog(nota))" />
                    </div>
                </RadzenColumn>
            }

            <RadzenButton Text="Aggiungi note" Variant="Variant.Text" Click="@AddNewNote" />
        </div>
    </div>
</div>


@code {
    [Parameter]
    public EventCallback OnCompaniesSelected { get; set; }

    [Parameter]
    public DocumentModel Document { get; set; } = new();

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();
    }


    private void AddNewNote()
    {
        Document.Notes.Add(new NoteModel());

    }

    private async Task OpenCompanyListDialog(NoteModel nota)
    {
        var Comps = Document.Companies;

        // creo uno style aggiuntivo da inviare al componente caricato con il popup come options
        var additionalStyle = $"min-height:fit-content;height:fit-content;max-width:600px";
        var newOptions = new DialogOptions
            {
                Style = additionalStyle
            };
        //creo parametri da inviare al componente caricato con il popup
        var param = new Dictionary<string, object>
        {
            //tra i parametri che invio al dialog creo un EventCallback da passare al componente
            { "OnCompaniesSelected", EventCallback.Factory.Create(this, SelectedCompanies) },
            { "Nota", nota },
            { "Companies", Comps },
        };
        await DialogService.OpenAsync<FormSelectCompanyDocumentNote>("Seleziona aziende", parameters: param, options: newOptions);
    }

    private void SelectedCompanies()
    {
        DialogService.Close();
        StateHasChanged();
    }

}