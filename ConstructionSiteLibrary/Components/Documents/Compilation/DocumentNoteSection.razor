@using Shared.Documents
@using ConstructionSiteLibrary.Components.Utilities;
@using ConstructionSiteLibrary.Repositories;
@using ConstructionSiteLibrary.Utility;
@using ConstructionSiteLibrary.Model.DocumentCompilation
@using Microsoft.AspNetCore.Components;
@using Radzen;
@using Radzen.Blazor;
@inject DialogService DialogService


@* NOTE AGGIUNTIVE *@
<div class="mt-3">
    <div class="marginYResponsive2 ">
        <a class="anchor" id="@CreateAnchor()"></a>
        <fieldset class="my-fieldset">
            <legend class="my-legend">@DocumentUtils.DocumentNotes</legend>

            @foreach (var nota in Document.Notes)
            {
                <RadzenColumn class="mt-4">
                    <RadzenTextArea Placeholder="Enter here..." class="w-100 my-input" Rows="5" Value="@nota.Text" Change="@(args=> AddTextNote(args, nota.Id))" />
                    <div class="row">
                        <div class="col-12">
                            <RadzenText TextStyle="TextStyle.Caption" class="mt-2">@ReportedCompany(nota.CompanyListIds)</RadzenText>
                            <div class="hstack">
                                <RadzenButton Icon="edit" Text="Assegna" Variant="Variant.Text" Style="width:140px;"
                                Click="@(()=>OpenCompanyListDialog(nota))" />
                                <RadzenButton ButtonStyle="ButtonStyle.Danger" Icon="delete" Text="elimina"
                                Variant="Variant.Text" Click="@(() => DeleteNote(nota))" />
                            </div>
                        </div>
                    </div>
                </RadzenColumn>
            }
            <div class="button-container">
                <RadzenButton Icon="add" Text="Aggiungi note" Variant="Variant.Filled" Click="@AddNewNote" />
            </div>
        </fieldset>
    </div>
</div>



@code {

    [Parameter]
    public EventCallback OnAnchorAdd { get; set; }
    [Parameter]
    public EventCallback OnCompaniesSelected { get; set; }
    [Parameter]
    public DocumentNavigator DocumentNavigator { get; set; } = new();
    [Parameter]
    public DocumentModel Document { get; set; } = new();

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();
    }


    private void AddNewNote()
    {

        var number = Document.Notes.Count();
        Document.Notes.Add(new NoteModel() { Id = number });

    }

    private void AddTextNote(string text, int number)
    {
        var note = Document.Notes.Where(x => x.Id == number).SingleOrDefault();
        if (note is not null)
        {
            note.Text = text;
        }
    }

    private async Task OpenCompanyListDialog(NoteModel nota)
    {
        var Comps = Document.Companies;

        // creo uno style aggiuntivo da inviare al componente caricato con il popup come options
        var additionalStyle = $"min-height:fit-content;height:fit-content;max-width:600px";
        var newOptions = new DialogOptions
            {
                Style = additionalStyle
            };
        //creo parametri da inviare al componente caricato con il popup
        var param = new Dictionary<string, object>
        {
            //tra i parametri che invio al dialog creo un EventCallback da passare al componente
            { "OnCompaniesSelected", EventCallback.Factory.Create(this, SelectedCompanies) },
            { "Nota", nota },
            { "Companies", Comps },
        };
        await DialogService.OpenAsync<FormSelectCompanyDocumentNote>("Seleziona aziende", parameters: param, options: newOptions);
    }

    private void SelectedCompanies()
    {
        DialogService.Close();
        StateHasChanged();
    }

    private string ReportedCompany(List<int> reportedCompanyIds)
    {
        var message = reportedCompanyIds.Count > 0 ? "(" : "";
        foreach (var companyId in reportedCompanyIds)
        {
            var companyName = Document.Companies.Where(x => x.Id == companyId).Select(x => x.CompanyName).FirstOrDefault() ?? "";
            message += $"{companyName}, ";
        }

        if (message.EndsWith(", "))
        {
            //rimuovo l'ultima virgola
            message = message.Remove(message.Length - 2);
            message += ")";
        }
        return message;
    }

    public async Task DeleteNote(NoteModel nota)
    {
        var result = await DialogService.Confirm("Sei sicuro di voler eliminare la nota?", "Conferma eliminazione nota") ?? false;
        if (result)
        {
            Document.Notes.Remove(nota);
            StateHasChanged();
        }
    }

    #region Gestione Ancore


    private string CreateAnchor()
    {
        var anchor = new DocumentAnchor(DocumentUtils.TypeDocumentNotes, 0, $"Note documento", $"document_notes");
        DocumentNavigator.AddAnchor(anchor);
        return anchor.Anchor;
    }

    #endregion

}