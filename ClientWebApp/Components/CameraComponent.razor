@using Microsoft.JSInterop
@using Radzen

@inject IJSRuntime JS
@inject DialogService DialogService


<RadzenButton Text="Fotocamera" Icon="photo_camera" Click="@OpenCamera" />
<RadzenButton Text="Documenti" Icon="folder" Click="@OpenDocuments" />
<InputFile OnChange="LoadFile" style="display: none;" id="pictureLoader"/>

@if (isCameraOpen)
{
  <video id="player" controls autoplay></video>

  <canvas id="canvas" width="320" height="240"></canvas>

  <RadzenButton Text="Scatta" Click="@TakePicture" />
}


@code {

  private IJSObjectReference jsModule;

  private bool isCameraOpen = false;

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    if(isCameraOpen)
    {
      await jsModule.InvokeVoidAsync("openCamera");
    }
    Console.WriteLine("Reloaded");
    await base.OnAfterRenderAsync(firstRender);
  }


  protected override async Task OnInitializedAsync()
  {
    await base.OnInitializedAsync();

    jsModule = await JS.InvokeAsync<IJSObjectReference>("import", "./camera-service.js");

  }

  public async Task OpenCamera()
  {
    isCameraOpen = true;
  }

  public void OpenDocuments()
  {
    jsModule.InvokeVoidAsync("openDocuments");
  }

  private async Task LoadFile(InputFileChangeEventArgs e)
  {
    Console.WriteLine("");
    var readStream = e.File.OpenReadStream(2048000);

    var buffer = new byte[e.File.Size];

    await readStream.ReadAsync(buffer, 0, buffer.Length);

    var base64Image = Convert.ToBase64String(buffer);

    DialogService.Close("data:image/jpeg;charset=utf-8;base64," + base64Image);
  }

  public async Task TakePicture()
  {
    await jsModule.InvokeVoidAsync("takePicture", DotNetObjectReference.Create(this));
  }


  [JSInvokable]
  public async Task GetImage(string base64Image)
  {
    DialogService.Close(base64Image);
  }

}
